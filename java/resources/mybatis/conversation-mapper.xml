<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssss.devportal.ai.admin.mapper.ConversationMapper">

    <!-- ConversationEntity ResultMap -->
    <resultMap id="conversationResultMap" type="com.ssss.devportal.ai.admin.entity.ConversationEntity">
        <id property="id" column="id"/>
        <result property="persona" column="PERSONA"/>
        <result property="userQuery" column="USER_QUERY"/>
        <result property="aiQuery" column="AI_QUERY"/>
        <result property="creator" column="CREATOR"/>
        <result property="createdDate" column="CREATED_DATE"/>
    </resultMap>

    <!-- 공통 WHERE 조건 -->
    <sql id="commonWhereClause">
        <where>
            <if test="personaCode != null and personaCode != ''">
                AND PERSONA = #{personaCode}
            </if>
            <if test="userId != null and userId != ''">
                AND CREATOR = #{userId}
            </if>
            <if test="startDate != null">
                AND CREATED_DATE >= #{startDate}
            </if>
            <if test="endDate != null">
                AND CREATED_DATE &lt;= #{endDate}
            </if>
        </where>
    </sql>

    <!-- 대화 목록 조회 (페이지네이션) -->
    <select id="findConversationsPaged" resultMap="conversationResultMap">
        SELECT 
            id,
            PERSONA,
            USER_QUERY,
            AI_QUERY,
            CREATOR,
            CREATED_DATE
        FROM swp_chatops_conversation_storage
        <include refid="commonWhereClause"/>
        ORDER BY CREATED_DATE DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 대화 목록 총 개수 조회 -->
    <select id="countConversations" resultType="long">
        SELECT COUNT(*)
        FROM swp_chatops_conversation_storage
        <include refid="commonWhereClause"/>
    </select>

    <!-- LLM 분석용 대화 데이터 조회 -->
    <select id="getConversationsForAnalysis" resultMap="conversationResultMap">
        SELECT 
            id,
            PERSONA,
            USER_QUERY,
            AI_QUERY,
            CREATOR,
            CREATED_DATE
        FROM swp_chatops_conversation_storage
        <where>
            <if test="personaCode != null and personaCode != ''">
                AND PERSONA = #{personaCode}
            </if>
            <if test="startDate != null">
                AND CREATED_DATE >= #{startDate}
            </if>
            <if test="endDate != null">
                AND CREATED_DATE &lt;= #{endDate}
            </if>
            <!-- 유효한 데이터만 조회 -->
            AND USER_QUERY IS NOT NULL 
            AND AI_QUERY IS NOT NULL
            AND CHAR_LENGTH(USER_QUERY) > 0
            AND CHAR_LENGTH(AI_QUERY) > 0
        </where>
        ORDER BY CREATED_DATE DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

</mapper>